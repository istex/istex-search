name: Tests

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out files
        uses: actions/checkout@v3

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: latest
          cache: npm

      - name: Install dependencies and run tests
        run: npm ci && npm run test:unit

  e2e-tests:
    runs-on: ubuntu-latest
    container: cypress/browsers:latest
    steps:
      - name: Check out files
        uses: actions/checkout@v3

        # Taken from https://nextjs.org/docs/pages/building-your-application/deploying/ci-build-caching#github-actions
      - name: Cache nextjs build directory
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: Cypress run
        uses: cypress-io/github-action@v5
        with:
          build: npm run build
          start: npm start
          browser: chrome
